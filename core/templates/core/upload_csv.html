{% extends "core/base.html" %}

{% block title %}Importuj transakcje z CSV{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Importuj transakcje z CSV</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Wybierz plik CSV</h5>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.as_p }}
                </div>
                <button type="submit" class="btn btn-primary">Importuj</button>
                 <a href="{% url 'reprocess_transactions' %}" class="btn btn-info float-end me-2">Przetwórz ponownie</a>
                 <a href="{% url 'clear_all_transactions' %}" class="btn btn-danger float-end">Wyczyść wszystkie transakcje</a>
            </form>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if upload_summary %}
        <div class="alert alert-info">
            <h3>Podsumowanie importu</h3>
            {% if upload_summary.error %}
                <p class="text-danger">Błąd: {{ upload_summary.error }}</p>
            {% else %}
                <p>Przetworzono poprawnie: {{ upload_summary.processed_count }} wierszy.</p>
                {% if upload_summary.encoding_warning %}
                    <p class="text-warning">
                        <strong>Ostrzeżenie kodowania:</strong> Plik CSV zawierał znaki niemożliwe
                        do zdekodowania w UTF-8. Zostały zastąpione znakiem zastępczym (<code>?</code>).
                        Sprawdź czy kwoty i nazwy kontrahentów są poprawne. Jeśli dane wyglądają
                        nieprawidłowo, spróbuj zapisać plik CSV w kodowaniu windows-1250.
                    </p>
                {% endif %}
                {% if upload_summary.skipped_rows %}
                    <p>Pominięto następujące wiersze:</p>
                    <ul>
                        {% for row_num, reason in upload_summary.skipped_rows %}
                            <li>Wiersz {{ row_num }}: {{ reason }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

    <hr>

    <h2>Historia transakcji</h2>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtruj transakcje</h5>
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="search_query" class="form-label">Szukaj (opis/kontrahent):</label>
                    <input type="text" name="search_query" id="search_query" value="{{ current_search_query|default:'' }}" class="form-control" placeholder="Wpisz tekst...">
                </div>
                <div class="col-md-2">
                    <label for="category" class="form-label">Kategoria:</label>
                    <select name="category" id="category" class="form-select">
                        <option value="">-- Wszystkie --</option>
                        {% for code, name in title_choices %}
                            <option value="{{ code }}" {% if current_category == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="lokal_id" class="form-label">Nr mieszkania:</label>
                    <select name="lokal_id" id="lokal_id" class="form-select">
                        <option value="">-- Wszystkie --</option>
                        {% for lokal in lokale %}
                            <option value="{{ lokal.id }}" {% if current_lokal_id == lokal.id|stringformat:"s" %}selected{% endif %}>
                                {{ lokal.unit_number }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">Od daty:</label>
                    <input type="date" name="date_from" id="date_from" value="{{ current_date_from|default:'' }}" class="form-control">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">Do daty:</label>
                    <input type="date" name="date_to" id="date_to" value="{{ current_date_to|default:'' }}" class="form-control">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary w-100">Filtruj</button>
                    <a href="{% url 'upload_csv' %}" class="btn btn-secondary w-100 mt-2">Wyczyść</a>
                </div>
            </form>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Opis</th>
                    <th>Przychód</th>
                    <th>Koszty</th>
                    <th>Dane kontrahenta</th>
                    <th>Tytułem</th>
                    <th>Nr mieszkania</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                    <tr class="{% if transaction.is_split_payment %}table-warning{% elif transaction.lokal %}table-success{% endif %}">
                        <td>
                            {{ transaction.id }}
                            {% if transaction.is_split_payment %}
                                <span title="Transakcja powstała w wyniku podziału">✂️</span>
                            {% endif %}
                            {% if transaction.status == 'MANUALLY_EDITED' %}
                                <span title="Transakcja edytowana ręcznie">✋</span>
                            {% endif %}
                        </td>
                        <td>{{ transaction.posting_date }}</td>
                        <td>{{ transaction.description }}</td>
                        {% if transaction.amount > 0 %}
                            <td class="text-success">{{ transaction.amount }}</td>
                            <td></td>
                        {% else %}
                            <td></td>
                            <td class="text-danger">{{ transaction.amount }}</td>
                        {% endif %}
                        <td>{{ transaction.contractor }}</td>
                        <td>{{ transaction.get_title_display }}</td>
                        <td>{{ transaction.lokal.unit_number|default:"-" }}</td>
                        <td>
                            <a href="{% url 'transaction-edit' transaction.pk %}" class="btn btn-sm btn-warning">Edytuj</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">Brak transakcji.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}